#compdef cargo

# Since we could not use `-Z native-completion` in generated bash completion script, we have to modify it manually until the feature is stable.
# source <(COMPLETE=zsh cargo -Z native-completion)

function _clap_dynamic_completer() {
    local _CLAP_COMPLETE_INDEX=$(expr $CURRENT - 1)
    local _CLAP_IFS=$'\n'

    local completions=("${(@f)$( \
        _CLAP_IFS="$_CLAP_IFS" \
        _CLAP_COMPLETE_INDEX="$_CLAP_COMPLETE_INDEX" \
        COMPLETE="zsh" \
        cargo -Z native-completion -- ${words} 2>/dev/null \
    )}")

    if [[ -n $completions ]]; then
        compadd -a completions
    fi
}

compdef _clap_dynamic_completer cargo